name: Security Scan - SCA SAST DAST
on: 
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  security:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      # Configuration Node.js pour DVNA
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      # SCA - Snyk Open Source (dépendances)
      - name: Run Snyk Open Source (SCA)
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --sarif-file-output=snyk-sca.sarif
          
      # SAST - Snyk Code (analyse statique)
      - name: Run Snyk Code (SAST)
        uses: snyk/actions/setup@master
      - run: snyk code test --sarif-file-output=snyk-sast.sarif
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          
      # Build de l'application DVNA pour DAST
      - name: Start DVNA application
        run: |
          npm start &
          sleep 30
          curl -f http://localhost:9090 || exit 1
        env:
          NODE_ENV: test
          
      # DAST - OWASP ZAP (test dynamique)
      - name: Run OWASP ZAP DAST
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:9090'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          
      # Upload tous les résultats vers GitHub Security
      - name: Upload Snyk SCA results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk-sca.sarif
          category: snyk-sca
          
      - name: Upload Snyk SAST results  
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk-sast.sarif
          category: snyk-sast